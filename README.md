# REFORMERS Digital Twin Model API Server

## Overview

This package implements the server for REFORMERS Digital Twin Model API, according to the dedicated [OpenAPI specification](https://github.com/REFORMERS-EnergyValleys/reformers-dt-model-api-specs).
It is developed on top of stubs generated by the [OpenAPI Generator](https://openapi-generator.tech), see [here](./GENERATOR.md) for more details.

## Requirements
Python 3.5.2+

## Usage

To run the server, please execute the following from the root directory:

```
pip3 install -r requirements.txt
python3 -m reformers_model_api_server
```

*Options*: provide as command line arguments

+ `-s TEXT`, `--specification TEXT`: OpenAPI specification file name
+ `-h TEXT`, `--host TEXT`: URL to repository
+ `--repo-auth-config TEXT`: path to authentication config file for accessing the repository (see [`repo-auth-config.json`](./repo-auth-config.json) for an example, default: */repo-auth-config.json*)
+ `--registry-auth-config TEXT`: path to authentication config file for accessing the container registries (see [`registry-auth-config.json`](./registry-auth-config.json) for an example, default: */registry-auth-config.json*)
+ `--metagenerator-auth-config TEXT`: path to authentication config file for accessing the container registries passed as input to metagenerators; this must correspond to the path through which the Docker daemon can access and mount the registries authorization config file
+ `--remove-containers BOOLEAN`: set this to false to remove containers after they have exited
+ `--verify-ssl BOOLEAN` set this to false to skip verifying SSL certificates
+ `--help`: show help message and exit

**NOTE**:
For the server to start-up, the repository as defined via `-h` / `--host` must be reachable.

Open your browser to here:

```
http://localhost:8080/api/ui/
```

The OpenAPI definition lives here:

```
http://localhost:8080/api/openapi.json
```

## Running with Docker

Build container image using a [Waitress WSGI server](https://docs.pylonsproject.org/projects/waitress/en/latest/) for the deployment of the Model API server:
```sh
docker build -t reformers-energyvalleys/model-api-server .
```

To run the server in a Docker container, execute the following from the root directory:

Linux:
```bash
docker run --rm -d -p 8080:80 -v /var/run/docker.sock:/var/run/docker.sock -v $PWD/repo-auth-config.json:/repo-auth-config.json -v $PWD/registry-auth-config.json:/registry-auth-config.json -e METAGENERATOR_AUTH_CONFIG=$PWD/registry-auth-config.json reformers-energyvalleys/model-api-server
```

Windows:
```cmd
docker run --rm -d -p 8080:80 -v /var/run/docker.sock:/var/run/docker.sock -v %CD%\repo-auth-config.json:/repo-auth-config.json -v %CD%\registry-auth-config.json:/registry-auth-config.json -e METAGENERATOR_AUTH_CONFIG=%CD%\registry-auth-config.json reformers-energyvalleys/model-api-server
```

**IMPORTANT**:
Files `repo-auth-config.json` and `registry-auth-config.json` are mounted to their default locations within the container.
However, environment variable `METAGENERATOR_AUTH_CONFIG` points to the path through which the Docker daemon can access and mount file `registry-auth-config.json` (i.e., the path in the host file system running the Docker daemon and not the path in the container's local file system).

*Options*: can be set as as environment variables for the container (flag `-e` / `--env`)

+ `SPECIFICATION`: OpenAPI specification file name
+ `HOST`: URL to repository
+ `REPO_AUTH_CONFIG`: path to authentication config file for accessing the repository
+ `REGISTRY_AUTH_CONFIG`: path to authentication config file for accessing the container registries
+ `METAGENERATOR_AUTH_CONFIG`: path to authentication config file for accessing the container registries passed as input to metagenerators
+ `REMOVE_CONTAINERS`: set this to `false` (or `0`) to remove containers after they have exited
+ `VERIFY_SSL`: set this to `false` (or `0`) to skip verifying SSL certificates

## Funding acknowledgement

<img alt="European Flag" src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/Flag_of_Europe.svg/330px-Flag_of_Europe.svg.png" align="left" style="margin-right: 10px" height="57"/> This development has been supported by the [REFORMERS] project of the European Unionâ€™s research and innovation programme Horizon Europe under the grant agreement No.101136211.

[REFORMERS]: https://reformers-energyvalleys.eu/
